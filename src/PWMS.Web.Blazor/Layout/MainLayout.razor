@inject ILocalStorageService LocalStorage
@inject AuthenticationStateProvider AuthenticationStateProvider

@inherits LayoutComponentBase
<MudLayout>
    <AuthorizeView>
        <Authorized>
            <MudAppBar Color="Color.Primary">
                <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="ToggleDrawer" />
                <MudSpacer />
                <MudMenu Label="@context.User.Claims.FirstOrDefault(c => c.Type == "username")?.Value"
                         EndIcon="@Icons.Material.Filled.KeyboardArrowDown"
                         Variant="Variant.Text"
                         Color="Color.Inherit"
                         AnchorOrigin="Origin.BottomCenter">
                    <MudMenuItem>Change Password</MudMenuItem>
                    <MudMenuItem OnClick="Logout">Logout</MudMenuItem>
                </MudMenu>
            </MudAppBar>
            <MudDrawer @bind-Open="@_open" Elevation="1" Variant="@DrawerVariant.Persistent" ClipMode="DrawerClipMode.Docked">
                <NavMenu />
            </MudDrawer>
            <MudMainContent>
                @Body
            </MudMainContent>
        </Authorized>
        <NotAuthorized>
            <MudMainContent>
                @Body
            </MudMainContent>
        </NotAuthorized>
    </AuthorizeView>
</MudLayout>

<MudThemeProvider />
<MudDialogProvider />
<MudSnackbarProvider />
<MudPopoverProvider />

@code {
    private bool _open = false;

    private void ToggleDrawer()
    {
        _open = !_open;
    }

    private async Task Logout()
    {
        await LocalStorage.RemoveItemAsync("authToken");
        await AuthenticationStateProvider.GetAuthenticationStateAsync();
    }
}